default:
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq rsync
    - export ENV_DIR=$SERVER_TEST_DIR/$CI_COMMIT_REF_NAME

stages:
  - unittest
  - deploy


test:
  stage: unittest
  script:
    - mkdir -p $ENV_DIR/current
    - rsync -a --info=progress2 --delete . $ENV_DIR/current/
    - rm -rf $ENV_DIR/venv
    - python3.8 -m venv $ENV_DIR/venv
    - source $ENV_DIR/venv/bin/activate && pip install -r $ENV_DIR/current/requirements.txt
  tags:
    - sys360
  when: manual


deploy:
  stage: deploy
  timeout: 20m
  before_script:
    - systemctl stop sys360.service
  script:
    - rsync -a --info=progress2 --delete . $SERVER_DIR/app
    - rm -rf $SERVER_DIR/venv
    - python3.8 -m venv $SERVER_DIR/venv && source $SERVER_DIR/venv/bin/activate && pip install -r $SERVER_DIR/app/requirements.txt && export FLASK=$SERVER_DIR/app/main.py && flask db migrate && flask db upgrade
    - systemctl start sys360.service
  tags:
    - sys360